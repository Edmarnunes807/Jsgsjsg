<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Scanner de Produtos</title>
  <!-- QuaggaJS -->
  <script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.js"></script>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      background: #fff;
      width: 100%;
      max-width: 420px;
      padding: 20px;
      border-radius: 18px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.35);
    }

    h1 {
      text-align: center;
      margin-bottom: 15px;
      font-size: 22px;
    }

    .input {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border-radius: 12px;
      border: 1px solid #ccc;
      margin-bottom: 10px;
    }

    .btn {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      border: none;
      border-radius: 12px;
      background: #2c5364;
      color: #fff;
      cursor: pointer;
      transition: 0.3s;
      margin-bottom: 10px;
    }

    .btn:hover {
      background: #203a43;
    }

    #scanner {
      display: none;
      margin-top: 10px;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      width: 100%;
      height: 300px;
      background: #000;
    }

    /* Moldura visual de foco melhorada */
    #scanner::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      height: 60px;
      border: 3px solid rgba(0, 255, 0, 0.6);
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
      pointer-events: none;
      z-index: 10;
      border-radius: 8px;
    }

    #scanner video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .resultado {
      display: none;
      margin-top: 15px;
      background: #f4f6f8;
      border-radius: 14px;
      padding: 15px;
      text-align: center;
    }

    .resultado img {
      max-width: 100%;
      max-height: 220px;
      object-fit: contain;
      margin-bottom: 10px;
    }

    .linha {
      margin: 6px 0;
      font-size: 15px;
    }

    .scanner-controls {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .scanner-controls .btn {
      flex: 1;
      padding: 10px;
      font-size: 14px;
    }

    .btn-parar {
      background: #dc3545 !important;
    }

    .btn-parar:hover {
      background: #c82333 !important;
    }

    .mensagem {
      text-align: center;
      color: #666;
      font-size: 14px;
      margin: 10px 0;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>üì¶ Scanner de Produtos</h1>

  <input
    type="text"
    id="codigoManual"
    class="input"
    placeholder="Digite o c√≥digo de barras"
    inputmode="numeric"
  />

  <button class="btn" onclick="buscarCodigoManual()">üîç Buscar C√≥digo</button>
  <button class="btn" onclick="iniciarScanner()" id="btnScanner">üì∑ Abrir Scanner</button>

  <div class="mensagem" id="mensagemScanner">
    Posicione o c√≥digo de barras dentro da √°rea verde
  </div>

  <div id="scanner"></div>

  <div class="scanner-controls" id="scannerControls" style="display: none;">
    <button class="btn btn-parar" onclick="pararScanner()">‚èπÔ∏è Parar Scanner</button>
    <button class="btn" onclick="alternarCamera()">üîÑ Alternar C√¢mera</button>
  </div>

  <div class="resultado" id="resultado">
    <img id="imagemProduto" style="display:none;">
    <div class="linha"><strong>C√≥digo:</strong> <span id="codigo"></span></div>
    <div class="linha"><strong>Produto:</strong> <span id="nome"></span></div>
    <div class="linha"><strong>Marca:</strong> <span id="marca"></span></div>
    <div class="linha"><strong>Quantidade:</strong> <span id="quantidade"></span></div>
  </div>
</div>

<script>
let scannerAtivo = false;
let cameraFrente = false;
let ultimoCodigoLido = '';
let timeoutDetecao;

function iniciarScanner() {
  if (scannerAtivo) return;

  const scannerDiv = document.getElementById("scanner");
  const mensagemDiv = document.getElementById("mensagemScanner");
  const controlsDiv = document.getElementById("scannerControls");
  const btnScanner = document.getElementById("btnScanner");
  
  scannerDiv.style.display = "block";
  mensagemDiv.style.display = "block";
  controlsDiv.style.display = "flex";
  btnScanner.style.display = "none";
  
  document.getElementById("codigoManual").style.display = "none";
  document.querySelector('button[onclick="buscarCodigoManual()"]').style.display = "none";

  Quagga.init({
    inputStream: {
      type: "LiveStream",
      target: scannerDiv,
      constraints: {
        facingMode: cameraFrente ? "user" : "environment",
        width: { min: 640, ideal: 1280, max: 1920 },
        height: { min: 480, ideal: 720, max: 1080 },
        aspectRatio: { ideal: 4/3 },
        advanced: [
          { zoom: { min: 1, max: 2, ideal: 1.5 } },
          { focusMode: "continuous" },
          { exposureMode: "continuous" },
          { whiteBalanceMode: "continuous" }
        ]
      },
      area: { // √Årea de detec√ß√£o maior
        top: "20%",
        right: "10%",
        left: "10%",
        bottom: "20%"
      }
    },
    locator: {
      patchSize: "large", // Aumentado para detectar c√≥digos pequenos
      halfSample: true
    },
    frequency: 10, // Verifica√ß√£o mais r√°pida
    numOfWorkers: navigator.hardwareConcurrency || 2,
    decoder: {
      readers: [
        "ean_reader",
        "ean_8_reader",
        "upc_reader",
        "upc_e_reader",
        "code_128_reader",
        "code_39_reader",
        "code_93_reader"
      ],
      multiple: false
    },
    locate: true,
    debug: {
      drawBoundingBox: true,
      showFrequency: false,
      drawScanline: true,
      showPattern: false
    }
  }, err => {
    if (err) {
      console.error("Erro ao iniciar scanner:", err);
      alert("Erro ao acessar a c√¢mera: " + err.message);
      pararScanner();
      return;
    }
    Quagga.start();
    scannerAtivo = true;
    mensagemDiv.innerHTML = "Scanner ativo! Aponte para o c√≥digo de barras";
  });

  Quagga.offDetected();
  Quagga.onDetected(data => {
    if (!scannerAtivo) return;
    
    const codigo = data.codeResult.code;
    const now = Date.now();
    
    // Prevenir leituras duplicadas r√°pidas
    if (codigo === ultimoCodigoLido && (now - timeoutDetecao) < 2000) {
      return;
    }
    
    ultimoCodigoLido = codigo;
    timeoutDetecao = now;
    
    // Feedback visual
    const scannerDiv = document.getElementById("scanner");
    scannerDiv.style.boxShadow = "0 0 30px rgba(0, 255, 0, 0.7)";
    setTimeout(() => {
      scannerDiv.style.boxShadow = "";
    }, 300);
    
    // Parar scanner temporariamente e buscar produto
    Quagga.stop();
    scannerAtivo = false;
    
    buscarProduto(codigo);
    
    // Mostrar mensagem
    document.getElementById("mensagemScanner").innerHTML = 
      `‚úÖ C√≥digo lido: ${codigo}<br>Buscando informa√ß√µes...`;
    
    // Reiniciar scanner ap√≥s 3 segundos
    setTimeout(() => {
      if (!scannerAtivo) {
        iniciarScanner();
      }
    }, 3000);
  });

  // Melhorar detec√ß√£o em condi√ß√µes ruins
  Quagga.onProcessed(function(result) {
    if (!result) return;
    
    const drawingCtx = Quagga.canvas.ctx.overlay;
    const drawingCanvas = Quagga.canvas.dom.overlay;
    
    if (result.codeResult && result.codeResult.code) {
      drawingCtx.font = "18px Arial";
      drawingCtx.fillStyle = 'green';
      drawingCtx.fillText(`C√≥digo: ${result.codeResult.code}`, 10, 20);
    }
  });
}

function pararScanner() {
  if (scannerAtivo) {
    Quagga.stop();
  }
  scannerAtivo = false;
  
  const scannerDiv = document.getElementById("scanner");
  const mensagemDiv = document.getElementById("mensagemScanner");
  const controlsDiv = document.getElementById("scannerControls");
  const btnScanner = document.getElementById("btnScanner");
  
  scannerDiv.style.display = "none";
  mensagemDiv.style.display = "none";
  controlsDiv.style.display = "none";
  btnScanner.style.display = "block";
  
  document.getElementById("codigoManual").style.display = "block";
  document.querySelector('button[onclick="buscarCodigoManual()"]').style.display = "block";
}

function alternarCamera() {
  pararScanner();
  cameraFrente = !cameraFrente;
  setTimeout(() => {
    iniciarScanner();
  }, 500);
}

function buscarCodigoManual() {
  const codigo = document.getElementById("codigoManual").value.trim();
  if (!codigo) {
    alert("Digite um c√≥digo v√°lido");
    return;
  }
  buscarProduto(codigo);
}

function buscarProduto(codigo) {
  // Mostrar loading
  const resultado = document.getElementById("resultado");
  resultado.style.display = "block";
  resultado.innerHTML = `<div class="mensagem">Buscando informa√ß√µes...</div>`;

  fetch(`https://world.openfoodfacts.org/api/v0/product/${codigo}.json`)
    .then(res => {
      if (!res.ok) throw new Error(`Erro HTTP: ${res.status}`);
      return res.json();
    })
    .then(data => {
      const resultado = document.getElementById("resultado");
      const img = document.getElementById("imagemProduto");

      resultado.style.display = "block";
      document.getElementById("codigo").innerText = codigo;

      if (data.status !== 1 || !data.product) {
        document.getElementById("nome").innerText = "Produto n√£o encontrado";
        document.getElementById("marca").innerText = "-";
        document.getElementById("quantidade").innerText = "-";
        img.style.display = "none";
        return;
      }

      const p = data.product;

      document.getElementById("nome").innerText = 
        p.product_name || p.product_name_pt || p.product_name_en || "N√£o informado";
      document.getElementById("marca").innerText = 
        p.brands || p.brand_owner || "N√£o informada";
      document.getElementById("quantidade").innerText = 
        p.quantity || p.product_quantity || "N√£o informada";

      if (p.image_front_url || p.image_url) {
        img.src = p.image_front_url || p.image_url;
        img.style.display = "block";
      } else {
        img.style.display = "none";
      }
    })
    .catch(err => {
      console.error("Erro na busca:", err);
      resultado.innerHTML = `<div class="mensagem">Erro ao buscar produto. Tente novamente.</div>`;
    });
}

// Fechar scanner ao pressionar ESC
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && scannerAtivo) {
    pararScanner();
  }
});
</script>

</body>
</html>
